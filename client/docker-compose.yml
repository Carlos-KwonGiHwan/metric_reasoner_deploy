version: "3.9"

services:
  otel-agent:
    image: otel/opentelemetry-collector-contrib:0.100.0  # contrib 이미지 필수
    container_name: otel-agent
    command: ["--config=/etc/otelcol/config.yaml"]
    user: "0:0"
    restart: unless-stopped
    network_mode: "host"  # [중요] 호스트 네트워크 사용

    volumes:
      - ${CONFIG_DIR}/otel-agent-config.yaml:/etc/otelcol/config.yaml:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/host/root:ro,rslave
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ${APP_LOG_DIR}:${APP_LOG_DIR}:ro

    environment:
      # 1. 연결 및 인증 정보
      - OTEL_EXPORTER_OTLP_ENDPOINT=${OTEL_COLLECTOR_HOST} # 예: 127.0.0.1:4317
      - GATEWAY_AUTH_TOKEN=${GATEWAY_AUTH_TOKEN}           # [추가] 인증 토큰

      # 2. 메타데이터 및 변수
      - NODE_ID=${NODE_ID}
      - APP_LOG_DIR=${APP_LOG_DIR}
      - DOCKER_API_VERSION=${DOCKER_API_VERSION:-1.24}
      - COLLECTION_INTERVAL=${COLLECTION_INTERVAL:-10s}
      - MEMORY_LIMIT_MIB=${MEMORY_LIMIT_MIB:-400}
      
      # 3. Host Metrics 경로 (Config 파일에서 참조)
      - HOST_PROC=/host/proc
      - HOST_SYS=/host/sys
      - HOST_FILESYSTEM=/host/root

      # 4. 리소스 속성 (자동 주입됨)
      - OTEL_RESOURCE_ATTRIBUTES=service.name=${OTEL_LOG_AGENT_NAME},deployment.environment=${DEPLOYMENT_ENV},system.version=${SYSTEM_VERSION},host.name=${NODE_ID}