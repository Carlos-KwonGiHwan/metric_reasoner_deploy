receivers:
  # 1) Node Exporter 대체 (호스트 CPU, 메모리, 디스크 등)
  hostmetrics:
    root_path: /host/root  # 호스트 파일시스템 마운트 경로
    collection_interval: 10s
    scrapers:
      cpu:
      memory:
      network:
      filesystem:
      load:
      disk:

  # 2) cAdvisor 대체 (컨테이너별 CPU, 메모리 사용량)
  docker_stats:
    endpoint: "unix:///var/run/docker.sock"
    collection_interval: 10s
    metrics:
      container.cpu.usage.total:
        enabled: true
      container.memory.usage.total:
        enabled: true
      container.network.io.usage.rx_bytes:
        enabled: true
      container.network.io.usage.tx_bytes:
        enabled: true

  # 3) 로그 수집
  filelog:
    include: ["/var/lib/docker/containers/*/*-json.log"] # 도커 표준 로그
    operators:
      - type: json_parser # 도커 로그는 JSON으로 래핑되어 있음
        timestamp:
          parse_from: time
          layout: '%Y-%m-%dT%H:%M:%S.%LZ'
        body:
          parse_from: log
    # (필요시 특정 앱 로그 파일 추가 가능)

processors:
  # 호스트 정보 자동 감지
  resourcedetection:
    detectors: [env, system, docker] # docker 디텍터가 container.name 등을 잡아줌
    timeout: 5s
    override: false

  # 메모리 보호 및 배치 전송
  memory_limiter:
    check_interval: 1s
    limit_mib: 400
  batch:

exporters:
  otlp:
    endpoint: "${OTEL_EXPORTER_OTLP_ENDPOINT}" # 중앙 수집기로 전송
    tls:
      insecure: true
  debug:
      verbosity: detailed

service:
  pipelines:
    metrics:
      receivers: [hostmetrics, docker_stats]
      processors: [resourcedetection, memory_limiter, batch]
      exporters: [otlp, debug]
    logs:
      receivers: [filelog]
      processors: [resourcedetection, memory_limiter, batch]
      exporters: [otlp, debug]