receivers:
  hostmetrics:
    root_path: /host/root
    collection_interval: "${env:COLLECTION_INTERVAL}"
    scrapers:
      cpu:
      memory:
      network:
      filesystem:
      load:
      disk:

  docker_stats:
    endpoint: "unix:///var/run/docker.sock"
    api_version: "${env:DOCKER_API_VERSION}"
    collection_interval: "${env:COLLECTION_INTERVAL}"
    metrics:
      container.cpu.usage.total: { enabled: true }
      container.memory.usage.total: { enabled: true }
      container.network.io.usage.rx_bytes: { enabled: true }
      container.network.io.usage.tx_bytes: { enabled: true }


  filelog:
    include:
      - "${env:APP_LOG_DIR}/**/*.log"
    operators:
      - type: regex_parser
        id: mysql_parser
        parse_from: body
        on_error: send
        if: 'body matches "^\\d{4}-\\d{2}-\\d{2}T"'
        regex: ^(?P<ts>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+Z)\s+(?P<body>.*)$
        timestamp:
          parse_from: attributes.ts
          layout: '%Y-%m-%dT%H:%M:%S.%fZ'

      - type: regex_parser
        id: python_parser
        parse_from: body
        if: 'attributes.conn_id == nil and body matches "^\\d{2}:\\d{2}:\\d{2}\\."'
        regex: >
          ^(?P<ts>\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d+Z)\s+
          (?P<conn_id>\d+)\s+
          (?P<cmd>[A-Za-z]+)
          (?:\s+(?P<msg>.*))?$        
        timestamp:
          parse_from: attributes.ts
          layout: '%H:%M:%S.%L'
        on_error: drop

      - type: move
        from: attributes.msg
        to: body
        if: 'attributes.msg != nil'

      - type: remove
        field: attributes.ts
        if: 'attributes.ts != nil'

      - type: add
        field: attributes.unparsed
        value: "true"
        if: 'attributes.conn_id == nil and attributes.level == nil'

  # 4. Docker 컨테이너 표준 로그 (stdout/stderr) 수집
  # filelog/docker:
  #   include:
  #     - /var/lib/docker/containers/*/*-json.log
  #   operators:
  #     # 1️⃣ Docker JSON 파싱 (가장 먼저)
  #     - type: json_parser
  #       id: parser_docker
  #       parse_from: body
  #       timestamp:
  #         parse_from: attributes.time
  #         layout: '%Y-%m-%dT%H:%M:%S.%fZ'

  #     # 2️⃣ 실제 로그 메시지 승격
  #     - type: move
  #       from: attributes.log
  #       to: body

  #     # 3️⃣ stdout / stderr
  #     - type: move
  #       from: attributes.stream
  #       to: attributes["log.stream"]

  #     # 4️⃣ container.id (방어적으로)
  #     - type: regex_parser
  #       id: extract_metadata_from_path
  #       parse_from: attributes["log.file.path"]
  #       if: 'attributes["log.file.path"] != nil'
  #       regex: 'containers/(?P<container_id>[a-z0-9]{64})/'
  #       to: resource["container.id"]
  #       on_error: drop


processors:
  resourcedetection:
    detectors: [env, system, docker]
    timeout: 5s
    override: false

  memory_limiter:
    check_interval: 1s
    limit_mib: ${env:MEMORY_LIMIT_MIB}

  filter/drop_otel:
    error_mode: ignore
    logs:
      log_record:
        - 'IsMatch(resource.attributes["container.image.name"], "otel/opentelemetry-collector")'
        - 'IsMatch(resource.attributes["container.name"], "otel-agent")'

  attributes/cleanup:
    actions:
      - key: time
        action: delete
      - key: unparsed
        action: delete
      - key: log.file.path
        action: delete


  batch:
    send_batch_size: 1000
    timeout: 5s

exporters:
  # otlp:
  #   # http://127.0.0.1:4317 등 .env 주소 사용
  #   endpoint: "http://${env:OTEL_COLLECTOR_HOST}"
  #   tls:
  #     insecure: true
  #   headers:
  #     # [Gateway 인증] .env의 토큰 사용
  #     Authorization: "Bearer ${env:GATEWAY_AUTH_TOKEN}"

  otlphttp:
    endpoint: "http://${env:OTEL_COLLECTOR_HOST}"
    headers:
      Authorization: "Bearer ${env:GATEWAY_AUTH_TOKEN}"
    tls:
      insecure: true

  debug:
    verbosity: basic

service:
  pipelines:
    metrics:
      receivers: [hostmetrics, docker_stats]
      processors: [resourcedetection, memory_limiter, batch]
      # exporters: [otlp]
      exporters: [otlphttp]

    logs:
      # [중요] 두 리시버 모두 포함해야 함
      receivers: [filelog, filelog/docker] 
      processors: [resourcedetection, filter/drop_otel, memory_limiter, attributes/cleanup, batch]
      # exporters: [otlp] # 문제 해결 후 debug 제거
      exporters: [otlphttp]