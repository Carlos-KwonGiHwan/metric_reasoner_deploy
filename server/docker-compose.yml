version: "3"

services:
  # --- 1. Load Balancer ---
  nginx-lb:
    image: nginx:latest
    container_name: nginx-lb
    ports:
      - "4317:4317" # 외부에서 들어오는 gRPC 요청
      - "4318:4318" # 외부에서 들어오는 HTTP 요청
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - otel-collector-1
      - otel-collector-2
      - otel-collector-3

  # --- 2. OTel Collectors (3 Replicas) ---
  # *중요: 호스트 포트(ports)를 매핑하지 않습니다. Nginx를 통해서만 통신합니다.
  otel-collector-1:
    image: signoz/signoz-otel-collector:0.88.10
    container_name: otel-collector-1
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    depends_on:
      - clickhouse

  otel-collector-2:
    image: signoz/signoz-otel-collector:0.88.10
    container_name: otel-collector-2
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    depends_on:
      - clickhouse

  otel-collector-3:
    image: signoz/signoz-otel-collector:0.88.10
    container_name: otel-collector-3
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    depends_on:
      - clickhouse

  # --- 3. SigNoz Backend (DB & UI) ---
  clickhouse:
    image: clickhouse/clickhouse-server:24.1.2-alpine
    ports:
      - "9000:9000"
      - "8123:8123"
    ulimits:
      nofile:
        soft: 262144
        hard: 262144
    volumes:
      - ./clickhouse-data:/var/lib/clickhouse
    depends_on:
      - zookeeper

  zookeeper:
    image: zookeeper:3.9
    ports:
      - "2181:2181"

  query-service:
    image: signoz/query-service:0.45.0
    command: ["-config=/root/config/prometheus.yml"]
    environment:
      - ClickHouseUrl=tcp://clickhouse:9000
      - STORAGE=clickhouse
      - GIGABYTE_INDEX_VERSION=v4
    ports:
      - "8080:8080"
    depends_on:
      - clickhouse

  frontend:
    image: signoz/frontend:0.45.0
    ports:
      - "3301:3301"
    depends_on:
      - query-service

volumes:
  clickhouse-data: