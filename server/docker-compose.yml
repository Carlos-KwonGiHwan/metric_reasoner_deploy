version: "3"

services:
  # --- 1. Load Balancer ---
  nginx-lb:
    image: nginx:latest
    container_name: nginx-lb
    ports:
      - "4317:4317" # 외부에서 들어오는 gRPC 요청
      - "4318:4318" # 외부에서 들어오는 HTTP 요청
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - otel-collector-1
      - otel-collector-2
      - otel-collector-3

  # --- 2. OTel Collectors (3 Replicas) ---
  # *중요: 호스트 포트(ports)를 매핑하지 않습니다. Nginx를 통해서만 통신합니다.
  otel-collector-1:
    image: signoz/signoz-otel-collector:0.88.10
    container_name: otel-collector-1
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    depends_on:
      - openobserve
    deploy:
      resources:
        limits:
          memory: 1500M

  otel-collector-2:
    image: signoz/signoz-otel-collector:0.88.10
    container_name: otel-collector-2
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    depends_on:
      - openobserve
    deploy:
      resources:
        limits:
          memory: 1500M

  otel-collector-3:
    image: signoz/signoz-otel-collector:0.88.10
    container_name: otel-collector-3
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
    depends_on:
      - openobserve
    deploy:
      resources:
        limits:
          memory: 1500M

  # --- 3. OpenObserve (Backend & UI) ---
  openobserve:
    image: public.ecr.aws/zinclabs/openobserve:latest
    container_name: openobserve
    restart: always
    ports:
      - "5080:5080" # UI 접속 포트
    volumes:
      - ./data:/data
    environment:
      - ZO_ROOT_USER_EMAIL=admin@example.com
      - ZO_ROOT_USER_PASSWORD=ChangeMe123!
      # S3 설정 (이전 대화 기반)
      - ZO_S3_BUCKET_NAME=my-openobserve-bucket
      - ZO_S3_REGION_NAME=ap-northeast-2
      - ZO_DATA_DIR=/data
      - ZO_STORAGE_TYPE=s3
      # AWS IAM Role 사용 시 아래 키 삭제 가능
      - AWS_ACCESS_KEY_ID=YOUR_ACCESS_KEY
      - AWS_SECRET_ACCESS_KEY=YOUR_SECRET_KEY